
{% extends "layout.html" %}

{% block title %}Construtor de Prescrição{% endblock %}

{% block content %}
<a href="{{ url_for('dashboard') }}" class="mb-4 text-sm text-sky-600 hover:underline dark:text-sky-400">&larr; Voltar para a busca</a>

<div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-white">{{ diagnosis }}</h1>
    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Fonte da diretriz: {{ template.protocolSource }}</p>
</div>

<form action="{{ url_for('prescription_builder', diagnosis=diagnosis) }}" method="POST" id="prescription-form">
    <!-- Campos ocultos para manter o estado -->
    <input type="hidden" name="diagnosis" value="{{ diagnosis }}">
    <input type="hidden" name="protocol_source" value="{{ template.protocolSource }}">
    <input type="hidden" name="prescription_id" value="{{ prescription_id or '' }}">
    <input type="hidden" id="action-input" name="action" value="">
    <input type="hidden" id="item-id-to-remove-input" name="item_id_to_remove" value="">


    <!-- Seção de Dados do Paciente -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Dados do Paciente</h2>
        <div class="space-y-4">
            <div>
                <label for="patient_name" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nome Completo</label>
                <input type="text" id="patient_name" name="patient_name" value="{{ patient_info.name or '' }}" class="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600">
            </div>
            <div>
                <label for="patient_document" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Documento (RG/CPF)</label>
                <input type="text" id="patient_document" name="patient_document" value="{{ patient_info.document or '' }}" class="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600">
            </div>
            <div>
                <label for="patient_address" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Endereço Completo</label>
                <input type="text" id="patient_address" name="patient_address" value="{{ patient_info.address or '' }}" class="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600">
            </div>
        </div>
    </div>
    
    <!-- Seção de Medicamentos -->
    <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4 mt-8">Medicamentos</h2>
    <div class="space-y-4">
        {% for item in prescription_items %}
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-4 {% if item.selected %}ring-2 ring-sky-500{% else %}opacity-70{% endif %}">
            <input type="hidden" name="item_id_{{ loop.index0 }}" value="{{ item.id }}">
            <input type="hidden" name="item_is_custom_{{ loop.index0 }}" value="{{ 'true' if item.isCustom else 'false' }}">
            <div class="flex items-start">
                <div class="flex-shrink-0 pt-1">
                    {% if item.isCustom %}
                        <button type="button" onclick="removeItem('{{ item.id }}')" class="p-1 text-red-500 hover:text-red-700">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                        </button>
                    {% else %}
                        <input type="checkbox" name="item_selected_{{ loop.index0 }}" class="h-6 w-6 rounded border-gray-300 text-sky-600 focus:ring-sky-500" {% if item.selected %}checked{% endif %}>
                    {% endif %}
                </div>
                <div class="ml-4 flex-1">
                     <div class="grid grid-cols-1 md:grid-cols-5 gap-x-4 gap-y-2 mb-3">
                         <div class="md:col-span-3">
                             <label class="text-sm font-medium text-slate-600 dark:text-slate-300">Medicamento</label>
                             <input type="text" name="item_name_{{ loop.index0 }}" value="{{ item.name }}" class="w-full p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md" {% if not item.isCustom %}{% endif %}>
                         </div>
                         <div class="md:col-span-2">
                              <label class="text-sm font-medium text-slate-600 dark:text-slate-300">Apresentação</label>
                             <input type="text" name="item_presentation_{{ loop.index0 }}" value="{{ item.presentation }}" class="w-full p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md" {% if not item.isCustom %}{% endif %}>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                          <div class="md:col-span-2">
                              <label class="text-sm font-medium text-slate-600 dark:text-slate-300">Posologia</label>
                              <textarea name="item_posology_{{ loop.index0 }}" rows="2" class="w-full p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md">{{ item.customPosology }}</textarea>
                          </div>
                          <div>
                              <label class="text-sm font-medium text-slate-600 dark:text-slate-300">Quantidade</label>
                              <input type="text" name="item_quantity_{{ loop.index0 }}" value="{{ item.quantity }}" class="w-full p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md">
                          </div>
                     </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-6">
        <button type="button" onclick="submitAction('add_item')" class="w-full flex justify-center items-center py-2 px-4 border-2 border-dashed border-sky-400 text-sky-600 font-medium rounded-lg hover:bg-sky-50 dark:hover:bg-sky-900/50">
            Adicionar Medicamento
        </button>
    </div>
</form>

<div class="mt-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
    <div class="flex flex-col sm:flex-row gap-4">
        <input form="prescription-form" type="text" name="custom_name" value="{{ prescription_name or diagnosis }}" placeholder="Nome do modelo (ex: 'Asma Aguda Padrão')" required class="w-full p-3 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600">
        <button type="button" onclick="submitAction('save_prescription')" class="w-full sm:w-auto flex justify-center items-center py-3 px-6 text-lg font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700">
            Salvar
        </button>
    </div>
</div>

<script>
function submitAction(actionName) {
    document.getElementById('action-input').value = actionName;
    document.getElementById('prescription-form').submit();
}

function removeItem(itemId) {
    document.getElementById('item-id-to-remove-input').value = itemId;
    submitAction('remove_item');
}
</script>

{% endblock %}
